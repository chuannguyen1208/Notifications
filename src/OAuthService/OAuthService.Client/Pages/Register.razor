@page "/register"
@rendermode InteractiveWebAssembly
@inject AuthService AuthService
@attribute [Authorize]

<h3>Register</h3>

<div class="row">
    <div class="col-4">
        @if (isSubmitSuccessful is bool success)
        {
            <div class="alert @(success ? "alert-success" : "alert-error")" role="alert">
                Registration @(success ? "successful" : "failed")!
            </div>
        }

        <EditForm Model="@Model" OnValidSubmit="Submit">
            <DataAnnotationsValidator />

            <div class="form-group">
                <InputText @bind-Value="Model!.Username" placeholder="Email" class="form-control mb-3" />
                <ValidationMessage For="@(() => Model.Username)" />
            </div>

            <div class="form-group">
                <InputText type="password" @bind-Value="Model.Password" placeholder="Password" class="form-control mb-3" />
                <ValidationMessage For="@(() => Model.Password)" />
            </div>

            <div class="form-group">
                <InputText type="password" @bind-Value="Model.ConfirmPassword" placeholder="Confirm password" class="form-control mb-3" />
                <ValidationMessage For="@(() => Model.ConfirmPassword)" />
            </div>

            <button type="submit" class="btn btn-primary">Register</button>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    public RegisterModel? Model { get; set; }

    private bool? isSubmitSuccessful;

    protected override void OnInitialized() => Model ??= new();

    private async Task Submit()
    {
        isSubmitSuccessful = await AuthService.RegisterAsync(Model!.Username!, Model.Password!);
    }

    public class RegisterModel
    {
        [Required(ErrorMessage = "Username is required")]
        public string? Username { get; set; }

        [Required(ErrorMessage = "Password is required")]
        [StringLength(16, ErrorMessage = "The {0} must be at least {2} characters long.", MinimumLength = 8)]
        public string? Password { get; set; }

        [Required(ErrorMessage = "Confirm password is required")]
        [Compare(nameof(Password), ErrorMessage = "Password and Confirm Password do not match")]
        public string? ConfirmPassword { get; set; }
    }
}
